# Ralph Progress Log
Started: Wed Feb 18 2026

## Codebase Patterns
- For SELF oracle fixtures, stage runtime SELF inputs from compatibility baseline `FX-SELF-001` and use only `loss.dat` as the staged spectrum source; staging oracle rewritten `loss.dat` (or extra `xmu.dat`) introduces deterministic parity drift.
- Fixture-scoped regression compares every artifact present in the baseline directory; if baseline includes staged entry files such as `feff.inp`, stage the same file under `<actual-root>/<fixture>/<actual-subdir>/` to avoid false missing-artifact mismatches.
- For FULLSPECTRUM oracle fixtures, stage runtime inputs from compatibility baseline `FX-FULLSPECTRUM-001`; using oracle rewritten `xmu.dat` as the next input collapses input/output separation and introduces deterministic parity drift.
- Oracle parity requires a committed baseline file for every module-owned output artifact (including diagnostics like `logfullspectrum.dat`); otherwise comparator reports deterministic `Missing baseline artifact` mismatches.
- RIXS output contract now includes deterministic `rixs.sh`; keep the canonical script template at `crates/feff-core/src/modules/rixs/rixs.sh.template` and wire it through module output assertions (core parity + CLI oracle checks) when touching RIXS artifacts.
- Oracle baseline logs can be fixture-id sensitive; regenerate committed `*-ORACLE-*` baselines with the same fixture ID used by the oracle manifest to avoid deterministic `log*.dat` exact-text drift.

## 2026-02-18 11:11:32 JST - US-001
- Replaced SELF placeholder spectral generation with SFCONV-kernel-backed outputs by adding `numerics::sfconv` and wiring `SelfEnergyModule` to compute/reuse one shared convolution state across artifact writers.
- Added committed oracle snapshot artifacts under `artifacts/fortran-baselines/FX-SELF-ORACLE-001/baseline/` and expanded `crates/feff-core/tests/self_parity.rs` with `FX-SELF-ORACLE-001` coverage plus core-artifact baseline assertions for `selfenergy.dat`, `sigma.dat`, and `specfunct.dat`.
- Fixed SELF oracle input staging in both parity tests and regression scaffolding to source input spectra from `FX-SELF-001` and stage only `loss.dat` for oracle parity runs; updated CLI SELF oracle regression header expectations to the SFCONV-backed output contract.
- Files changed: `crates/feff-core/src/numerics/mod.rs`, `crates/feff-core/src/numerics/sfconv/mod.rs`, `crates/feff-core/src/modules/self_energy/model.rs`, `crates/feff-core/src/modules/self_energy/mod.rs`, `crates/feff-core/src/modules/regression.rs`, `crates/feff-core/tests/self_parity.rs`, `crates/feff-core/tests/sfconv_regression.rs`, `tasks/sfconv-regression-fixtures.json`, `artifacts/fortran-baselines/FX-SELF-ORACLE-001/baseline/*`, `crates/feff-cli/tests/regression_cli.rs`, `crates/feff-core/tests/parser_validation_snapshots.rs`, `crates/feff-core/tests/parser_fixture_inputs.rs`, `crates/feff-core/tests/numerics_reference_data.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: Oracle SELF parity is stable only when staged input spectra come from compatibility snapshots, not oracle output snapshots.
  - Gotchas encountered: Running cargo quality commands in parallel causes lock contention in this workspace; run checks sequentially.
  - Useful context: `cargo fmt --all -- --check` currently reports widespread pre-existing formatting drift across many untouched files; this iteration kept formatting scoped to touched story files.
---
## 2026-02-18 11:19:51 JST - US-002
- Added oracle baseline assertions in `crates/feff-core/tests/self_parity.rs` for SELF auxiliary artifacts (`loss.dat`, `mpse.dat`, `opconsCu.dat`, `sig2FEFF.dat`, `logsfconv.dat`) so `FX-SELF-ORACLE-001` locks full auxiliary parity.
- Added deterministic oracle staging coverage in `crates/feff-core/tests/self_parity.rs` to verify `FX-SELF-ORACLE-001` stages only `loss.dat` spectra while consistently sourcing optional `exc.dat` and required `sfconv.inp` from `FX-SELF-001`.
- Verified with `cargo check --locked`, `cargo test --locked`, `cargo clippy --locked --all-targets -- -D warnings`, and `cargo test --locked -p feff-core --test self_parity` after formatting the touched file.
- Files changed: `crates/feff-core/tests/self_parity.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: Local regression spot-checks for oracle fixtures must stage any baseline-owned entry artifacts (not only module outputs) to avoid comparator false negatives.
  - Gotchas encountered: `cargo fmt --all -- --check` still fails due widespread pre-existing formatting drift in untouched files; do scoped formatting for touched files unless running a dedicated repo-wide formatting sweep.
  - Useful context: SELF auxiliary artifacts were already byte-identical to committed oracle baselines; the missing piece was explicit regression guard coverage.
---
## 2026-02-18 11:26:24 JST - US-003
- Added `FX-FULLSPECTRUM-ORACLE-001` coverage in `crates/feff-core/tests/fullspectrum_parity.rs`, including committed-baseline assertions for table artifacts (`xmu.dat`, `osc_str.dat`, `eps.dat`, `drude.dat`, `background.dat`, `fine_st.dat`).
- Updated FULLSPECTRUM oracle staging in parity tests to source runtime inputs from `FX-FULLSPECTRUM-001` (compatibility seed) and added deterministic staging checks for `fullspectrum.inp`, `xmu.dat`, `prexmu.dat`, and `referencexmu.dat`.
- Added committed oracle baseline snapshot files under `artifacts/fortran-baselines/FX-FULLSPECTRUM-ORACLE-001/baseline/` for required table outputs plus fixture staging inputs.
- Verified with `cargo check --locked`, `cargo test --locked`, `cargo clippy --locked --all-targets -- -D warnings`, `cargo test --locked -p feff-core --test fullspectrum_parity`; `cargo fmt --all -- --check` still reports pre-existing repo-wide formatting drift outside this story scope.
- Files changed: `crates/feff-core/tests/fullspectrum_parity.rs`, `artifacts/fortran-baselines/FX-FULLSPECTRUM-ORACLE-001/baseline/*`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: FULLSPECTRUM oracle staging should always map `FX-FULLSPECTRUM-ORACLE-001` input reads back to `FX-FULLSPECTRUM-001` to keep input/output contracts deterministic.
  - Gotchas encountered: `xmu.dat` is both FULLSPECTRUM input and output, so oracle baselines cannot safely be reused as next-run input sources.
  - Useful context: This story intentionally locked only table artifacts; `logfullspectrum.dat` parity remains scoped to `US-004`.
---
## 2026-02-18 11:34:17 JST - US-004
- Added committed oracle baseline snapshot `artifacts/fortran-baselines/FX-FULLSPECTRUM-ORACLE-001/baseline/logfullspectrum.dat` from deterministic FULLSPECTRUM runtime output for `FX-FULLSPECTRUM-ORACLE-001`.
- Expanded `crates/feff-core/tests/fullspectrum_parity.rs` with committed-baseline parity coverage for `logfullspectrum.dat` plus a fixture-level regression assertion that `FX-FULLSPECTRUM-ORACLE-001` has zero mismatches against committed baseline artifacts.
- In the new committed-baseline regression guard, staged `feff.inp` alongside FULLSPECTRUM inputs so baseline-owned entry artifacts do not trigger false `Missing actual artifact` failures.
- Verified with `cargo check --locked`, `cargo test --locked`, `cargo clippy --locked --all-targets -- -D warnings`, `cargo fmt --all -- --check`, and `cargo test --locked -p feff-core --test fullspectrum_parity`.
- Files changed: `artifacts/fortran-baselines/FX-FULLSPECTRUM-ORACLE-001/baseline/logfullspectrum.dat`, `crates/feff-core/tests/fullspectrum_parity.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: Oracle FULLSPECTRUM parity is only zero-mismatch when both module outputs and baseline-owned entry artifacts are present in staged actual directories.
  - Gotchas encountered: Leaving `logfullspectrum.dat` out of committed oracle baselines causes deterministic comparator failures even when runtime output is stable.
  - Useful context: The new `oracle_fullspectrum_fixture_has_zero_mismatches_against_committed_baseline` test is the fastest guard for this fixture-level contract.
---
## 2026-02-18 11:49:08 JST - US-005
- Materialized deterministic `rixs.sh` as a first-class RIXS output by extending the runtime output contract in `crates/feff-core/src/modules/rixs/mod.rs` and wiring `RixsModel` artifact rendering to a committed shell-script template (`crates/feff-core/src/modules/rixs/rixs.sh.template`).
- Updated focused regression coverage for the new artifact in `crates/feff-core/tests/rixs_parity.rs` (required-output contract now includes `rixs.sh` plus a committed-baseline content assertion) and related CLI/runtime checks in `crates/feff-cli/tests/regression_cli.rs`, `crates/feff-cli/tests/cli_compatibility.rs`, `crates/feff-core/src/modules/dispatch.rs`, and `crates/feff-core/src/modules/regression.rs`.
- Quality checks: `cargo check --locked` passed, `cargo test --locked` passed, `cargo clippy --locked --all-targets -- -D warnings` passed; `cargo fmt --all -- --check` still reports pre-existing repo-wide formatting drift outside this story scope.
- Files changed: `crates/feff-core/src/modules/rixs/model.rs`, `crates/feff-core/src/modules/rixs/mod.rs`, `crates/feff-core/src/modules/rixs/rixs.sh.template`, `crates/feff-core/tests/rixs_parity.rs`, `crates/feff-cli/tests/regression_cli.rs`, `crates/feff-cli/tests/cli_compatibility.rs`, `crates/feff-core/src/modules/dispatch.rs`, `crates/feff-core/src/modules/regression.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: RIXS fixture parity expectations should treat `rixs.sh` as part of the required output contract, not an optional helper artifact.
  - Gotchas encountered: Running `cargo fmt --all -- --check` currently surfaces pre-existing formatting drift in untouched files; keep story diffs scoped unless intentionally doing a repo-wide formatting sweep.
  - Useful context: `approved_rixs_fixture_emits_committed_shell_script` in `crates/feff-core/tests/rixs_parity.rs` is the fastest guard for script-content parity with committed baselines.
---
## 2026-02-18 12:03:48 JST - US-006
- Reworked `crates/feff-cli/tests/regression_cli.rs` SELF/EELS/FULLSPECTRUM/RIXS oracle coverage to run fixed-fixture pass scenarios (`exit code 0`, `passed=true`, zero mismatches) plus explicit drift-mode scenarios that perturb staged inputs and assert nonzero mismatch diagnostics.
- Added committed fixed-fixture baselines for CLI oracle pass-mode coverage at `artifacts/fortran-baselines/FX-EELS-ORACLE-001/baseline/` and `artifacts/fortran-baselines/FX-RIXS-ORACLE-001/baseline/`, including fixture-id-correct diagnostic logs consumed by exact-text comparator checks.
- Preserved artifact-level JSON report assertions for module-owned outputs in both pass and drift paths (SELF spectral outputs, EELS `eels.dat`, FULLSPECTRUM table/log outputs, and full RIXS output contract including `rixs.sh`).
- Quality checks: `cargo check --locked` passed, `cargo test --locked` passed, `cargo clippy --locked --all-targets -- -D warnings` passed, `cargo test --locked -p feff-cli --test regression_cli` passed; `cargo fmt --all -- --check` still fails due pre-existing repository-wide formatting drift in untouched files.
- Files changed: `crates/feff-cli/tests/regression_cli.rs`, `artifacts/fortran-baselines/FX-EELS-ORACLE-001/baseline/*`, `artifacts/fortran-baselines/FX-RIXS-ORACLE-001/baseline/*`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: Oracle CLI regression is most stable with one fixed-fixture pass path and one explicit drift path per module, so both green parity and failure diagnostics stay locked.
  - Gotchas encountered: Compatibility fixtures like `FX-EELS-001` can still drift in module-owned outputs; strict zero-mismatch CLI assertions should target dedicated `*-ORACLE-*` baselines.
  - Useful context: `log*.dat` artifacts may encode fixture identity; regenerate baselines through oracle runs using the same fixture ID as the test manifest.
---
