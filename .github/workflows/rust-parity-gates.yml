name: Rust Parity Gates

on:
  push:
  pull_request:

jobs:
  rust-parity:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install stable Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run full fixture oracle parity suite
        id: parity
        shell: bash
        run: |
          set -u
          mkdir -p artifacts/regression
          capture_runner="${ORACLE_CAPTURE_RUNNER:-${GITHUB_WORKSPACE}/scripts/fortran/ci-oracle-capture-runner.sh}"

          set +e
          cargo run --locked -- oracle \
            --manifest tasks/golden-fixture-manifest.json \
            --policy tasks/numeric-tolerance-policy.json \
            --oracle-root artifacts/fortran-oracle-capture \
            --oracle-subdir outputs \
            --actual-root artifacts/fortran-baselines \
            --actual-subdir baseline \
            --report artifacts/regression/oracle-report.json \
            --capture-runner "${capture_runner}" \
            --capture-allow-missing-entry-files \
            > artifacts/regression/oracle-summary.txt \
            2> artifacts/regression/oracle-stderr.txt
          parity_exit_code=$?
          set -e

          if [[ -f artifacts/regression/oracle-report.json ]]; then
            jq -r '
              def status(v): if v then "PASS" else "FAIL" end;
              "Oracle parity status: \(status(.passed))",
              "Failed fixtures: \(.failed_fixture_count)",
              "Failed artifacts: \(.failed_artifact_count)",
              "Mismatched fixtures: \(.mismatch_fixture_count // 0)",
              "Mismatched artifacts: \(.mismatch_artifact_count // 0)",
              "",
              "Mismatched artifact details:",
              (
                (.mismatch_fixtures // [])[]
                | "Fixture \(.fixture_id):",
                  (
                    .artifacts[]
                    | "  - \(.artifact_path): \(.reason // \"comparison failed\")"
                  )
              )
            ' artifacts/regression/oracle-report.json > artifacts/regression/oracle-diff.txt
          else
            {
              echo "Oracle parity report JSON was not generated."
              echo "Command exit code: ${parity_exit_code}"
              echo
              echo "stderr:"
              cat artifacts/regression/oracle-stderr.txt
            } > artifacts/regression/oracle-diff.txt
          fi

          cat artifacts/regression/oracle-summary.txt
          if [[ -s artifacts/regression/oracle-stderr.txt ]]; then
            cat artifacts/regression/oracle-stderr.txt >&2
          fi

          echo "parity_exit_code=${parity_exit_code}" >> "${GITHUB_OUTPUT}"

      - name: Upload parity diff artifacts
        if: steps.parity.outputs.parity_exit_code != '0'
        uses: actions/upload-artifact@v4
        with:
          name: oracle-parity-failure-artifacts
          path: |
            artifacts/regression/oracle-report.json
            artifacts/regression/oracle-diff.txt
            artifacts/regression/oracle-summary.txt
            artifacts/regression/oracle-stderr.txt
          if-no-files-found: warn

      - name: Fail job on parity mismatch
        if: steps.parity.outputs.parity_exit_code != '0'
        run: |
          echo "Parity gate failed with exit code ${{ steps.parity.outputs.parity_exit_code }}."
          exit 1
