name: Rust Parity Gates

on:
  push:
  pull_request:

jobs:
  rust-parity:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install stable Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run full fixture regression parity suite
        id: parity
        shell: bash
        run: |
          set -u
          mkdir -p artifacts/regression

          set +e
          cargo run --locked -- regression \
            --manifest tasks/golden-fixture-manifest.json \
            --policy tasks/numeric-tolerance-policy.json \
            --baseline-root artifacts/fortran-baselines \
            --actual-root artifacts/fortran-baselines \
            --baseline-subdir baseline \
            --actual-subdir baseline \
            --report artifacts/regression/report.json \
            > artifacts/regression/regression-summary.txt \
            2> artifacts/regression/regression-stderr.txt
          parity_exit_code=$?
          set -e

          if [[ -f artifacts/regression/report.json ]]; then
            jq -r '
              def status(v): if v then "PASS" else "FAIL" end;
              "Regression status: \(status(.passed))",
              "Failed fixtures: \(.failed_fixture_count)",
              "Failed artifacts: \(.failed_artifact_count)",
              "",
              "Failed artifact details:",
              (
                .fixtures[]
                | select(.passed | not)
                | "Fixture \(.fixture_id):",
                  (
                    .artifacts[]
                    | select(.passed | not)
                    | "  - \(.artifact_path): \(.reason // (if .comparison then (.comparison.mode + \" mismatch\") else \"comparison failed\" end))"
                  )
              )
            ' artifacts/regression/report.json > artifacts/regression/regression-diff.txt
          else
            {
              echo "Regression report JSON was not generated."
              echo "Command exit code: ${parity_exit_code}"
              echo
              echo "stderr:"
              cat artifacts/regression/regression-stderr.txt
            } > artifacts/regression/regression-diff.txt
          fi

          cat artifacts/regression/regression-summary.txt
          if [[ -s artifacts/regression/regression-stderr.txt ]]; then
            cat artifacts/regression/regression-stderr.txt >&2
          fi

          echo "parity_exit_code=${parity_exit_code}" >> "${GITHUB_OUTPUT}"

      - name: Upload parity diff artifacts
        if: steps.parity.outputs.parity_exit_code != '0'
        uses: actions/upload-artifact@v4
        with:
          name: regression-parity-failure-artifacts
          path: |
            artifacts/regression/report.json
            artifacts/regression/regression-diff.txt
            artifacts/regression/regression-summary.txt
            artifacts/regression/regression-stderr.txt
          if-no-files-found: warn

      - name: Fail job on parity mismatch
        if: steps.parity.outputs.parity_exit_code != '0'
        run: |
          echo "Parity gate failed with exit code ${{ steps.parity.outputs.parity_exit_code }}."
          exit 1
